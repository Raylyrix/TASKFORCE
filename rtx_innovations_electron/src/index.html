<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TASK FORCE - AutoMailer Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Enhanced Editor Styles -->
    <style>
        /* Inline critical CSS for immediate loading */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f7;
        }
        
        .header {
            background: #ffffff;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .mailer-interface {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            
        /* Enhanced Editor Toolbar Styles */
        .toolbar-group {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 12px;
            padding: 2px;
        }
        
        .toolbar-group button {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .toolbar-group button:hover {
            background: #f0f0f0;
            border-color: #007AFF;
        }
        
        .toolbar-group button:active {
            background: #e0e0e0;
        }
        
        .toolbar-group select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: #fff;
        }
        
        .toolbar-group input[type="color"] {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Editor Placeholder */
        #emailEditor[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
            pointer-events: none;
        }
        
        /* Table Styles */
        #emailEditor table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        #emailEditor table td,
        #emailEditor table th {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        #emailEditor table th {
            background: #f8f9fa;
            font-weight: bold;
        }
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }
        
        .btn-secondary:hover {
            background: #e5e5e7;
        }
        
        .btn-danger {
            background: #FF3B30;
            color: white;
        }
        
        .btn-danger:hover {
            background: #D70015;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: #34C759;
        }
        
        .status-indicator.disconnected {
            background: #FF3B30;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            background: #34C759;
        }
        
        .notification-error {
            background: #FF3B30;
        }
        
        .data-preview {
            margin-top: 20px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
        }
        
        th {
            background: #f2f2f7;
            font-weight: 600;
        }
        
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .campaign-card {
            background: white;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            padding: 20px;
        }
        
        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.running {
            background: #FF9500;
            color: white;
        }
        
        .status-badge.completed {
            background: #34C759;
            color: white;
        }
        
        .status-badge.draft {
            background: #8E8E93;
            color: white;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8E8E93;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8E8E93;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
	<div class="app-container" style="display:block; height:auto; min-height:100vh;">
		<!-- Top Navigation Bar -->
		<div class="header" style="position: sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e5e7; display:flex; align-items:center; justify-content:space-between; padding:10px 16px;">
			<div style="display:flex; align-items:center; gap:12px;">
				<h1 style="font-size:18px; margin:0;">TASK FORCE</h1>
				<p style="color:#8E8E93; margin:0; font-size:12px;">Send bulk emails with Google Sheets integration</p>
			</div>
			<div style="display:flex; gap:8px; align-items:center; position:relative;">
				<button id="googleSignInTopBtn" class="btn btn-secondary" style="border-radius:6px; border:1px solid #d0d0d4; color:#2c2c2e; background:#fff;">Sign in with Google</button>
				<button id="googleLogoutBtn" class="btn btn-secondary" style="border-radius:6px; border:1px solid #d0d0d4; color:#2c2c2e; background:#fff; display:none;">Logout</button>
                <select id="accountsSelect" style="min-width:220px; padding:8px 10px; border:1px solid #e5e5e7; border-radius:6px;">
                    <option value="">Select account</option>
                </select>
                <button class="btn btn-secondary" id="loginBtn"><i class="fas fa-sign-in-alt"></i>Login</button>
				<button class="btn btn-secondary" id="importSheetBtn"><i class="fas fa-file-import"></i>Import</button>
				<button class="btn btn-secondary" id="togglePreviewBtn"><i class="fas fa-table"></i>Preview</button>
				<button class="btn btn-secondary" id="logsBtn"><i class="fas fa-list"></i>Logs</button>
				<button class="btn btn-secondary" id="themeToggle"><i class="fas fa-moon"></i>Theme</button>
				<button class="btn btn-secondary" id="helpToolbarBtn"><i class="fas fa-circle-question"></i>Help</button>
				<div id="helpDropdown" style="display:none; position:absolute; right:0; top:100%; margin-top:8px; background:#ffffff; border:1px solid #e5e5e7; border-radius:8px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); overflow:hidden; min-width:220px;">
					<button class="btn btn-secondary" id="helpCheckBtn" style="display:block; width:100%; text-align:left; border-radius:0; padding:10px 12px;">Check for Updates</button>
					<button class="btn btn-secondary" id="helpWelcomeBtn" style="display:block; width:100%; text-align:left; border-radius:0; padding:10px 12px;">Welcome</button>
					<button class="btn btn-secondary" id="helpReleaseNotesBtn" style="display:block; width:100%; text-align:left; border-radius:0; padding:10px 12px;">Release Notes</button>
					<button class="btn btn-secondary" id="helpAboutBtn" style="display:block; width:100%; text-align:left; border-radius:0; padding:10px 12px;">About</button>
				</div>
                </div>
            </div>
            
		<div class="main-content" style="width:100%;">
			<div class="content-area" style="padding:16px;">
				<div class="mailer-interface" style="max-width:unset; width:100%;">
					<h2 style="margin-bottom: 16px; color: #1d1d1f;">Email Campaign Manager</h2>
					<div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
						<!-- These buttons now live in the top bar, keeping here for keyboard access if needed -->
						<button class="btn btn-secondary" id="importSheetBtn" style="display:none;"><i class="fas fa-file-import"></i>Import Spreadsheet</button>
						<button class="btn btn-secondary" id="togglePreviewBtn" style="display:none;"><i class="fas fa-table"></i>Toggle Data Preview</button>
						<button class="btn btn-secondary" id="logsBtn" style="display:none;"><i class="fas fa-list"></i>Logs</button>
            </div>
            
					<!-- Account and From -->
					<div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
						<div style="background:#f2f2f7; padding: 12px 16px; border-radius:8px; display:flex; align-items:center; gap:10px;">
							<div class="status-indicator disconnected" id="authStatus"></div>
							<span id="accountStatus">Not Connected</span>
                    </div>
						<div class="form-group" style="margin:0;">
							<label>From Address <span id="signatureInfo" style="color:#8E8E93; font-weight:400; font-size:12px; margin-left:6px;"></span></label>
							<select id="fromAddress"></select>
							<div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
								<input type="text" id="fromOverride" placeholder="Or type a custom From email" style="flex:1;">
								<small style="color:#8E8E93;">Use a verified alias for best deliverability</small>
                    </div>
                </div>
            </div>

					<div id="dataPreviewDrawer" style="display:none; position:relative; border:1px solid #e5e5e7; border-radius:8px; padding:12px; margin-bottom:16px; background:#fff; z-index:1000;">
						<div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
							<div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
								<strong>Sheet Data Preview</strong>
								<input type="text" id="placeholderSearch" placeholder="Search columns..." style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:180px;">
								<select id="previewPosition" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px;">
									<option value="top">Top</option>
									<option value="bottom">Bottom</option>
									<option value="left">Left</option>
									<option value="right">Right</option>
								</select>
								<button class="btn btn-secondary" id="previewFullscreenBtn"><i class="fas fa-expand"></i>Fullscreen</button>
                </div>
							<button class="btn btn-secondary" id="closePreviewBtn"><i class="fas fa-times"></i></button>
                </div>
						<div id="previewTableZone" class="table-container"></div>
                    </div>
                    
					<!-- Google Sheets Connection -->
					<div style="margin-bottom: 16px; padding: 16px; background: #f2f2f7; border-radius: 8px;">
						<h3 style="margin-bottom: 10px;">Step 1: Connect Google Sheets</h3>
						<div class="form-group" style="margin-bottom:10px;">
							<label>Google Sheets URL</label>
							<input type="text" id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/...">
                            </div>
						<div id="sheetTabsContainer" class="form-group" style="margin-bottom:10px;"></div>
						<button class="btn btn-primary" id="connectSheetsBtn2">
							<i class="fas fa-link"></i>Connect Sheets
						</button>
						<button class="btn btn-secondary" id="refreshSheetsBtn" disabled>
							<i class="fas fa-sync"></i>Refresh Data
						</button>
						<div id="sheetsData" style="display: none; margin-top: 12px;"></div>
                        </div>
                        
					<!-- Email Campaign Form -->
					<div style="margin-bottom: 16px;">
						<h3 style="margin-bottom: 10px;">Step 2: Create Email Campaign</h3>
						<div class="form-group">
							<label>Campaign Name</label>
							<input type="text" id="campaignName" placeholder="Enter campaign name">
                            </div>
						<div class="form-group">
							<label>Subject Line</label>
							<input type="text" id="campaignSubject" placeholder="Enter email subject">
                            </div>
						<div class="form-group">
							<label>From Name</label>
							<input type="text" id="fromName" placeholder="Your name">
                        </div>
						<div class="form-group">
							<label style="display:flex; align-items:center; justify-content:space-between;">
								<span>Email Content</span>
								<span style="font-size:12px; color:#8E8E93;">Click any column chip or cell to insert placeholders</span>
							</label>
							<div id="editorToolbar" style="border:1px solid #e1e5e9; border-bottom:none; padding:12px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius:8px 8px 0 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
								<!-- Font Controls -->
								<span class="toolbar-group">
									<select id="fontFamily" title="Font Family">
										<option value="arial" selected>Arial</option>
										<option value="helvetica">Helvetica</option>
										<option value="times new roman">Times New Roman</option>
										<option value="georgia">Georgia</option>
										<option value="verdana">Verdana</option>
										<option value="monospace">Monospace</option>
										<option value="courier new">Courier New</option>
										<option value="tahoma">Tahoma</option>
									</select>
									<select id="fontSize" title="Font Size">
										<option value="8px">8</option>
										<option value="10px">10</option>
										<option value="12px">12</option>
										<option value="14px" selected>14</option>
										<option value="16px">16</option>
										<option value="18px">18</option>
										<option value="20px">20</option>
										<option value="24px">24</option>
										<option value="28px">28</option>
										<option value="32px">32</option>
										<option value="36px">36</option>
										<option value="48px">48</option>
									</select>
								</span>
								
								<!-- Text Formatting -->
								<span class="toolbar-group">
									<button type="button" id="boldBtn" title="Bold (Ctrl+B)" onclick="execCommand('bold')"><strong>B</strong></button>
									<button type="button" id="italicBtn" title="Italic (Ctrl+I)" onclick="execCommand('italic')"><em>I</em></button>
									<button type="button" id="underlineBtn" title="Underline (Ctrl+U)" onclick="execCommand('underline')"><u>U</u></button>
									<button type="button" id="strikeBtn" title="Strikethrough" onclick="execCommand('strikeThrough')"><s>S</s></button>
									<button type="button" id="codeBtn" title="Inline Code" onclick="execCommand('insertText', '`code`')">`</button>
									<button type="button" id="codeBlockBtn" title="Code Block" onclick="execCommand('formatBlock', '<pre>')">Code</button>
								</span>
								
								<!-- Colors and Background -->
								<span class="toolbar-group">
									<input type="color" id="textColor" title="Text Color" onchange="execCommand('foreColor', this.value)">
									<input type="color" id="bgColor" title="Background Color" onchange="execCommand('hiliteColor', this.value)">
									<button type="button" id="clearFormatBtn" title="Clear Formatting" onclick="execCommand('removeFormat')">Clear</button>
								</span>
								
								<!-- Alignment and Indentation -->
								<span class="toolbar-group">
									<button type="button" id="h1Btn" title="Heading 1" onclick="execCommand('formatBlock', '<h1>')">H1</button>
									<button type="button" id="h2Btn" title="Heading 2" onclick="execCommand('formatBlock', '<h2>')">H2</button>
									<button type="button" id="h3Btn" title="Heading 3" onclick="execCommand('formatBlock', '<h3>')">H3</button>
									<select id="alignSelect" title="Text Alignment" onchange="execCommand('justifyLeft')">
										<option value="left">Left</option>
										<option value="center">Center</option>
										<option value="right">Right</option>
										<option value="justify">Justify</option>
									</select>
									<button type="button" id="indentBtn" title="Increase Indent" onclick="execCommand('indent')">→</button>
									<button type="button" id="outdentBtn" title="Decrease Indent" onclick="execCommand('outdent')">←</button>
								</span>
								
								<!-- Lists and Formatting -->
								<span class="toolbar-group">
									<button type="button" id="orderedListBtn" title="Numbered List" onclick="execCommand('insertOrderedList')">1.</button>
									<button type="button" id="bulletListBtn" title="Bullet List" onclick="execCommand('insertUnorderedList')">•</button>
									<button type="button" id="quoteBtn" title="Quote" onclick="execCommand('formatBlock', '<blockquote>')">"</button>
									<button type="button" id="linkBtn" title="Insert Link" onclick="insertLink()">🔗</button>
									<button type="button" id="imageBtn" title="Insert Image" onclick="insertImage()">🖼️</button>
								</span>
								
								<!-- Table and History -->
								<span class="toolbar-group">
									<button type="button" id="tableBtn" title="Insert Table" onclick="insertTable()">⊞</button>
									<button type="button" id="undoBtn" title="Undo (Ctrl+Z)" onclick="execCommand('undo')">↶</button>
									<button type="button" id="redoBtn" title="Redo (Ctrl+Y)" onclick="execCommand('redo')">↷</button>
								</span>
								
								<!-- Copy-Paste Debug -->
								<span class="toolbar-group" style="margin-left:auto;">
									<button type="button" id="testCopyPasteBtn" title="Test Copy-Paste" onclick="testCopyPaste()">Test CP</button>
									<button type="button" id="showContentBtn" title="Show Content" onclick="showEditorContent()">Show</button>
									<button type="button" id="copyPasteHelpBtn" title="Copy-Paste Help" onclick="showCopyPasteHelp()">Help</button>
								</span>
							</div>
							
							<!-- Enhanced Editor Container -->
							<div id="emailEditorContainer" style="border:1px solid #e1e5e9; border-top:none; border-radius:0 0 8px 8px; min-height:300px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
								<div id="emailEditor" contenteditable="true" style="padding:20px; min-height:300px; outline:none; font-family:Arial, sans-serif; font-size:14px; line-height:1.6; color:#333; border-radius:0 0 8px 8px;" 
									 data-placeholder="Start typing your email content here... Click any column chip or cell to insert placeholders like ((Name)), ((Company)), etc."></div>
							</div>
							
							<!-- Copy-Paste Debug Panel -->
							<div id="copyPasteDebug" style="display:none; margin-top:8px; padding:8px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px; font-size:12px;">
								<strong>Copy-Paste Debug:</strong> <span id="debugInfo">Ready</span>
							</div>
							<div style="margin-top:8px; font-size:11px; color:#6c757d;">
								<label style="display:flex; align-items:center; gap:4px;">
									<input type="checkbox" id="enableDebugPanel"> Show copy-paste debug information
								</label>
							</div>
                        </div>
						<div id="placeholderAssistant" class="form-group" style="margin-top:-6px;">
							<div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
								<input type="text" id="assistantSearch" placeholder="Search placeholders..." style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; min-width:180px;">
								<div id="assistantChips" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
                            </div>
                        </div>
						<div style="display:flex; align-items:center; gap:12px; margin-bottom: 10px; flex-wrap:wrap;">
							<label style="display:flex; align-items:center; gap:8px;">
								<input type="checkbox" id="useSignature"> Include Gmail Signature
							</label>
							<button class="btn btn-secondary" id="previewEmailBtn"><i class="fas fa-eye"></i>Preview</button>
                            </div>
						<div class="form-group">
							<label>Attachments</label>
							<div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
								<button class="btn btn-secondary" id="pickAttachmentsBtn"><i class="fas fa-paperclip"></i>Choose Files</button>
								<button class="btn btn-danger" id="clearAttachmentsBtn"><i class="fas fa-trash"></i>Clear All</button>
								<span id="attachmentsLabel" style="color:#8E8E93;">No files selected</span>
							</div>
							<div id="attachmentsList" style="margin-top:8px; display:flex; flex-direction:column; gap:6px;"></div>
						</div>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
							<div class="form-group">
								<label>Batch Size</label>
								<input type="number" id="batchSize" value="50" min="1" max="100">
                    </div>
							<div class="form-group">
								<label>Delay Between Emails (seconds)</label>
								<input type="number" id="emailDelay" value="5" min="1" max="60">
                        </div>
                    </div>
						<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;">
							<select id="templateSelect" style="min-width:180px;"></select>
							<button class="btn btn-secondary" id="loadTemplateBtn"><i class="fas fa-download"></i>Load</button>
							<button class="btn btn-secondary" id="saveTemplateBtn"><i class="fas fa-save"></i>Save</button>
							<button class="btn btn-danger" id="deleteTemplateBtn"><i class="fas fa-trash"></i>Delete</button>
                </div>
						<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center;">
							<label style="min-width:120px;">Preset templates</label>
							<select id="presetTemplateSelect" style="min-width:220px;"></select>
							<button class="btn btn-secondary" id="insertPresetBtn"><i class="fas fa-plus"></i>Insert</button>
							<button class="btn btn-secondary" id="testCopyPasteBtn"><i class="fas fa-clipboard"></i>Test Copy-Paste</button>
							<button class="btn btn-secondary" id="showContentBtn"><i class="fas fa-eye"></i>Show Content</button>
							<button class="btn btn-secondary" id="copyPasteHelpBtn"><i class="fas fa-question-circle"></i>Help</button>
						</div>
						<div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap:wrap; align-items:flex-end;">
							<button class="btn btn-secondary" id="sendTestBtn">
								<i class="fas fa-paper-plane"></i>Send Test Email
                            </button>
							<button class="btn btn-primary" id="startCampaignBtn">
								<i class="fas fa-rocket"></i>Start Campaign
                            </button>
							<!-- Filters -->
							<div class="form-group" style="margin:0; min-width:120px;">
								<label style="font-size:12px;">From</label>
								<input type="number" id="filterFrom" placeholder="1">
							</div>
							<div class="form-group" style="margin:0; min-width:120px;">
								<label style="font-size:12px;">To</label>
								<input type="number" id="filterTo" placeholder="" >
                        </div>
							<div class="form-group" style="margin:0; min-width:140px;">
								<label style="font-size:12px;">Parity</label>
								<select id="filterParity">
									<option value="all">All</option>
									<option value="even">Even</option>
									<option value="odd">Odd</option>
								</select>
                                </div>
							<div class="form-group" style="margin:0; min-width:200px;">
								<label style="font-size:12px;">Placeholder key present</label>
								<input type="text" id="filterPlaceholderKey" placeholder="e.g. EMAIL or Name">
                            </div>
							<div class="form-group" style="margin:0; min-width:200px;">
								<label style="font-size:12px;">Status contains</label>
								<input type="text" id="filterStatusText" placeholder="e.g. red/error">
                        </div>
                    </div>
                </div>

					<!-- Scheduling -->
					<div style="margin-bottom: 16px; padding: 16px; background: #f2f2f7; border-radius: 8px;">
						<h3 style="margin-bottom: 10px;">Step 3: Schedule (Optional)</h3>
						<div style="display:grid; grid-template-columns: 1fr auto; gap: 12px; align-items:end;">
							<div class="form-group" style="margin:0;">
								<label>Send At</label>
								<input type="datetime-local" id="scheduleDateTime">
							</div>
							<button class="btn btn-secondary" id="scheduleBtn" onclick="window.rtxApp && window.rtxApp.scheduleOneTimeSend()"><i class="fas fa-clock"></i>Schedule</button>
                    </div>
						<div id="scheduleList" style="margin-top:12px;"></div>
                        </div>
                        
					<!-- Campaigns List -->
					<div>
						<h3 style="margin-bottom: 10px;">Campaign History</h3>
						<div id="campaignsList">
                            <div class="empty-state">
                                <i class="fas fa-envelope-open"></i>
                                <h3>No Campaigns Yet</h3>
                                <p>Create your first email campaign to get started</p>
                            </div>
                        </div>
                    </div>
                            </div>
                        </div>
                    </div>
                </div>

	<!-- Login Modal -->
	<div class="modal" id="loginModal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>Login</h3>
				<button class="modal-close" onclick="document.getElementById('loginModal').style.display='none'">&times;</button>
						</div>
			<div class="modal-body">
				<div style="display:flex; flex-direction:column; gap:18px;">
					<div style="background:#f7f7fa; border:1px solid #e5e5e7; border-radius:8px; padding:12px;">
						<h4 style="margin-bottom:8px;">Option A: Gmail App Password (Recommended)</h4>
						<p style="font-size:13px; color:#666; margin-bottom:8px;">Enter your Gmail address and App Password. We never store your regular password. App Passwords can be revoked anytime in your Google Account.</p>
						<div class="form-group" style="margin-bottom:8px;">
							<label>Gmail Address</label>
							<input type="email" id="smtpEmail" placeholder="you@gmail.com">
						</div>
						<div class="form-group" style="margin-bottom:8px;">
							<label>Gmail App Password</label>
							<input type="password" id="smtpAppPassword" placeholder="16-character app password">
						</div>
						<div style="display:flex; gap:10px;">
							<button class="btn btn-primary" id="smtpLoginBtn"><i class="fas fa-right-to-bracket"></i>Login</button>
							<button class="btn btn-secondary" id="smtpFetchSignatureBtn"><i class="fas fa-signature"></i>Fetch Signature</button>
						</div>
					</div>

					<div style="background:#f7f7fa; border:1px solid #e5e5e7; border-radius:8px; padding:12px;">
						<h4 style="margin-bottom:8px;">Option B: Google OAuth (Legacy)</h4>
						<p style="font-size:13px; color:#666; margin-bottom:8px;">Upload your Google OAuth client credentials JSON. Not required for most users.</p>
						<div class="form-group" style="margin-bottom:8px;">
							<label>Upload Google API Credentials</label>
							<input type="file" id="credentialsFile" accept=".json">
						</div>
						<button class="btn btn-secondary" id="uploadCredentialsBtn">
							<i class="fas fa-upload"></i>Upload & Connect
						</button>
						<div class="muted" style="margin-top:8px;">Or use <strong>Sign in with Google</strong> from the main screen (recommended). Upload is optional for advanced users.</div>
                    </div>

					<div style="display:flex; gap: 10px; margin-top: 10px;">
						<button class="btn btn-secondary" onclick="document.getElementById('loginModal').style.display='none'">Close</button>
					</div>
				</div>
							</div>
					</div>
			</div>

	<!-- Loading Overlay -->
	<div class="loading-overlay" id="loadingOverlay" style="display: none;">
		<div class="loading-content">
			<i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #007AFF; margin-bottom: 15px;"></i>
			<p id="loadingMessage">Loading...</p>
                    </div>
                        </div>
                        
	<div class="modal" id="logsModal" style="display:none;">
		<div class="modal-content" style="max-width: 900px; width: 90%;">
			<div class="modal-header">
				<h3>Session Logs</h3>
				<button class="modal-close" onclick="document.getElementById('logsModal').style.display='none'">&times;</button>
                            </div>
			<div class="modal-body">
				<pre id="logsContent" style="white-space:pre-wrap; max-height:70vh; overflow:auto; background:#0b0b0f; color:#d7d7db; padding:16px; border-radius:8px; font-size:12px;"></pre>
                        </div>
                    </div>
                </div>

	<!-- Signature Builder Modal -->
	<div class="modal" id="signatureBuilderModal" style="display:none;">
		<div class="modal-content" style="max-width: 900px; width: 90%;">
			<div class="modal-header">
				<h3>Signature Builder</h3>
				<button class="modal-close" onclick="document.getElementById('signatureBuilderModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body">
				<div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
					<!-- Editor Panel -->
					<div>
						<h4>Signature Editor</h4>
						<div class="form-group">
							<label>Signature Name</label>
							<input type="text" id="sigName" placeholder="e.g. Default, Business, Personal">
						</div>
						<div class="form-group">
							<label>HTML Content</label>
							<div id="signatureEditorToolbar" style="border:1px solid #ddd; border-bottom:none; padding:8px; background:#f8f9fa;">
								<button type="button" onclick="execCommand('bold')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;"><strong>B</strong></button>
								<button type="button" onclick="execCommand('italic')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;"><em>I</em></button>
								<button type="button" onclick="execCommand('underline')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;"><u>U</u></button>
								<button type="button" onclick="execCommand('insertUnorderedList')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;">•</button>
								<button type="button" onclick="execCommand('insertOrderedList')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;">1.</button>
								<button type="button" onclick="execCommand('createLink')" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;">🔗</button>
								<button type="button" onclick="insertImage()" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;">🖼️</button>
								<button type="button" onclick="clearFormatting()" style="padding:4px 8px; margin:2px; border:1px solid #ccc; background:#fff; cursor:pointer;">🧹</button>
							</div>
							<div id="signatureEditor" contenteditable="true" style="height:200px; border:1px solid #ddd; padding:12px; overflow-y:auto; background:#fff;" placeholder="Enter your signature content..."></div>
						</div>
						<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
							<button class="btn btn-primary" onclick="saveSignature()"><i class="fas fa-save"></i>Save Signature</button>
							<button class="btn btn-secondary" onclick="loadSignature()"><i class="fas fa-download"></i>Load</button>
							<button class="btn btn-danger" onclick="deleteSignature()"><i class="fas fa-trash"></i>Delete</button>
							<button class="btn btn-secondary" onclick="applySignature()"><i class="fas fa-check"></i>Use in Emails</button>
						</div>
					</div>
					
					<!-- Preview Panel -->
					<div>
						<h4>Preview & Management</h4>
						<div class="form-group">
							<label>Signature Preview</label>
							<div id="signaturePreview" style="min-height:200px; border:1px solid #ddd; padding:12px; background:#fff; overflow-y:auto;"></div>
						</div>
						<div class="form-group">
							<label>Saved Signatures</label>
							<select id="signatureSelect" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
								<option value="">Select a signature to load...</option>
							</select>
						</div>
						<div style="background:#f8f9fa; padding:12px; border-radius:4px; font-size:12px;">
							<strong>Tips:</strong>
							<ul style="margin:8px 0; padding-left:20px;">
								<li>Use HTML for rich formatting (bold, italic, links)</li>
								<li>Images should use absolute URLs (https://...)</li>
								<li>Keep signatures concise for better email delivery</li>
								<li>Test your signature before using in campaigns</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Signature Modal -->
	<div class="modal" id="signatureModal" style="display:none;">
		<div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
				<h3>Signature Builder</h3>
				<button class="modal-close" onclick="document.getElementById('signatureModal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
				<div class="form-group">
					<label>Signature Name</label>
					<input type="text" id="sigName" placeholder="e.g. Default">
				</div>
				<div class="form-group">
					<label>Signature HTML</label>
					<textarea id="sigHtml" rows="10" placeholder="Paste or edit HTML (images with absolute URLs)"></textarea>
                    </div>
				<div style="display:flex; gap:8px; flex-wrap:wrap;">
					<button class="btn btn-primary" id="saveSignatureBtn"><i class="fas fa-save"></i>Save</button>
					<button class="btn btn-secondary" id="loadSignatureBtn"><i class="fas fa-download"></i>Load</button>
					<button class="btn btn-danger" id="deleteSignatureBtn"><i class="fas fa-trash"></i>Delete</button>
					<button class="btn btn-secondary" id="applySignatureBtn"><i class="fas fa-check"></i>Use in emails</button>
                    </div>
				<div style="margin-top:12px; border:1px solid #e5e5e7; border-radius:8px; padding:10px;">
					<div id="sigPreview" style="min-height:80px;">Signature Preview</div>
                </div>
				<small class="muted">Tip: Host images (logo/icons) and use full URLs (https://…). Inline base64 images also work.</small>
            </div>
        </div>
    </div>

	<div class="modal" id="emailPreviewModal" style="display:none;">
		<div class="modal-content" style="max-width: 900px; width: 90%;">
			<div class="modal-header">
				<h3>Email Preview</h3>
				<button class="modal-close" onclick="document.getElementById('emailPreviewModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body" id="emailPreviewBody" style="max-height:70vh; overflow:auto;"></div>
        </div>
    </div>

	<!-- About Modal -->
	<div class="modal" id="aboutModal" style="display:none;">
		<div class="modal-content" style="max-width: 600px; width: 90%;">
			<div class="modal-header">
				<h3>About TASK FORCE</h3>
				<button class="modal-close" onclick="document.getElementById('aboutModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body">
				<p><strong>Version:</strong> <span id="aboutVersion">-</span></p>
				<p>Mass mailer with Google Sheets integration by RTX Innovations.</p>
			</div>
		</div>
	</div>

	<!-- Welcome Modal -->
	<div class="modal" id="welcomeModal" style="display:none;">
		<div class="modal-content" style="max-width: 700px; width: 90%;">
			<div class="modal-header">
				<h3>Welcome to TASK FORCE</h3>
				<button class="modal-close" onclick="document.getElementById('welcomeModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body">
				<p>Thanks for installing TASK FORCE. Use the steps to connect Google Sheets and send personalized emails in bulk.</p>
				<ol>
					<li>Login using Gmail App Password or OAuth</li>
					<li>Paste your Google Sheets URL</li>
					<li>Compose your email using placeholders like ((Name))</li>
					<li>Send a test, then start the campaign</li>
				</ol>
			</div>
		</div>
	</div>

	<!-- Release Notes Modal -->
	<div class="modal" id="releaseNotesModal" style="display:none;">
		<div class="modal-content" style="max-width: 700px; width: 90%;">
			<div class="modal-header">
				<h3>Release Notes</h3>
				<button class="modal-close" onclick="document.getElementById('releaseNotesModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body" id="releaseNotesBody"></div>
		</div>
	</div>

	<!-- Privacy Modal -->
	<div class="modal" id="privacyModal" style="display:none;">
		<div class="modal-content" style="max-width: 800px; width: 90%;">
			<div class="modal-header"><h3>Privacy Policy</h3><button class="modal-close" onclick="document.getElementById('privacyModal').style.display='none'">&times;</button></div>
			<div class="modal-body" style="max-height:70vh; overflow:auto;">
				<p>We do not collect or transmit your personal data. OAuth tokens and SMTP App Passwords are stored locally on your device using secure storage. Emails are sent directly from your account to recipients. Logs remain on your device unless you share them.</p>
				<p>When using the web app, content is processed in your browser. If you opt into a relay for SMTP, credentials are used only for that request and not stored.</p>
			</div>
		</div>
	</div>

	<!-- Terms Modal -->
	<div class="modal" id="termsModal" style="display:none;">
		<div class="modal-content" style="max-width: 800px; width: 90%;">
			<div class="modal-header"><h3>Terms of Service</h3><button class="modal-close" onclick="document.getElementById('termsModal').style.display='none'">&times;</button></div>
			<div class="modal-body" style="max-height:70vh; overflow:auto;">
				<p>By using TASK FORCE, you agree to send emails only to recipients who have consented to receive them and to comply with Gmail and local anti-spam laws. You are responsible for your account and content. This software is provided “as-is” without warranties.</p>
			</div>
		</div>
	</div>

	<!-- Google Sign-in Modal -->
	<div class="modal" id="googleSignInModal" style="display:none;">
		<div class="modal-content" style="max-width: 700px;">
			<div class="modal-header">
				<h3>🔐 Google Sign-in</h3>
				<button class="modal-close" onclick="document.getElementById('googleSignInModal').style.display='none'">&times;</button>
			</div>
			<div class="modal-body">
				<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
					<h4 style="margin-bottom: 10px; color: #007AFF;">🚀 Quick Authentication</h4>
					<p style="color: #666; margin-bottom: 15px;">
						Choose your preferred authentication method. We recommend the <strong>Manual Authorization Code</strong> for fastest login.
					</p>
				</div>
				
				<div class="form-group">
					<label style="font-weight: 600; color: #333;">📋 Manual Authorization Code (Recommended)</label>
					<div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
						<input type="text" id="manualAuthCode" placeholder="Paste your authorization code here..." style="flex: 1; padding: 12px; font-size: 14px;">
						<button class="btn btn-primary" onclick="submitManualAuthCode()" style="padding: 12px 20px;">
							<i class="fas fa-sign-in-alt"></i> Login
						</button>
					</div>
					<div style="background: #e8f4fd; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #007AFF;">
						<strong>💡 How to get the code:</strong>
						<ol style="margin: 8px 0 0 20px; color: #555;">
							<li>Click "Start Google Sign-in" below</li>
							<li>Complete the Google authorization in your browser</li>
							<li>Copy the authorization code from the success page</li>
							<li>Paste it here and click Login</li>
						</ol>
					</div>
				</div>
				
				<div style="text-align: center; margin: 20px 0; color: #999;">
					<span style="background: #fff; padding: 0 10px;">OR</span>
					<hr style="margin: 0; border: none; border-top: 1px solid #ddd; position: relative; top: -10px;">
				</div>
				
				<div class="form-group">
					<label style="font-weight: 600; color: #333;">🔄 Automatic Redirect</label>
					<button class="btn btn-secondary" onclick="startGoogleAuth()" id="startAuthBtn" style="width: 100%; padding: 15px; font-size: 16px; margin-top: 8px;">
						<i class="fas fa-sign-in-alt"></i> Start Google Sign-in
					</button>
					<small style="color: #666; margin-top: 8px; display: block;">
						This will open your browser for Google authorization. Return here after completion.
					</small>
				</div>
				
				<div class="form-group">
					<label style="font-weight: 600; color: #333;">📁 Custom OAuth Credentials (Advanced)</label>
					<input type="file" id="oauthFile" accept=".json" style="margin-top: 8px;">
					<small style="color: #666; margin-top: 8px; display: block;">
						Upload your own OAuth credentials file. Leave empty to use our default credentials.
					</small>
				</div>
				
				<div id="authProgress" style="display:none; margin-top: 20px;">
					<div style="background: #f0f8ff; padding: 16px; border-radius: 8px; border: 1px solid #007AFF;">
						<div style="display: flex; align-items: center; gap: 12px;">
							<div class="spinner" style="width: 20px; height: 20px; border-top-color: #007AFF;"></div>
							<span id="authStatus" style="color: #007AFF; font-weight: 500;">Initializing authentication...</span>
						</div>
					</div>
				</div>
				
				<div id="authError" style="display:none; margin-top: 20px;">
					<div style="background: #fef2f2; color: #dc2626; padding: 16px; border-radius: 8px; border: 1px solid #fecaca;">
						<strong>❌ Authentication Error:</strong> <span id="errorMessage"></span>
					</div>
				</div>
				
				<!-- Debug Section -->
				<div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffeaa7;">
					<h5 style="margin-bottom: 10px; color: #856404;">🔧 Troubleshooting</h5>
					<div style="display: flex; gap: 8px; flex-wrap: wrap;">
						<button class="btn btn-warning" onclick="debugAuthStatus()" style="padding: 8px 16px; font-size: 14px;">
							<i class="fas fa-bug"></i> Debug Auth Status
						</button>
						<button class="btn btn-secondary" onclick="clearAuthData()" style="padding: 8px 16px; font-size: 14px;">
							<i class="fas fa-trash"></i> Clear Auth Data
						</button>
						<button class="btn btn-info" onclick="showAuthHelp()" style="padding: 8px 16px; font-size: 14px;">
							<i class="fas fa-question-circle"></i> Help
						</button>
					</div>
					<div id="debugOutput" style="display:none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
				</div>
				
				<div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 20px;">
					<h5 style="margin-bottom: 10px; color: #333;">ℹ️ About Authentication</h5>
					<ul style="color: #666; margin: 0; padding-left: 20px;">
						<li>We use secure OAuth 2.0 for Google authentication</li>
						<li>Your credentials are stored locally and never shared</li>
						<li>You can revoke access anytime in your Google Account settings</li>
						<li>This app only requests access to Gmail and Google Sheets</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<script>
		// Theme toggle behavior
		document.getElementById('themeToggle')?.addEventListener('click', () => {
			const body = document.body; const isDark = body.classList.contains('theme-dark');
			if (isDark) { body.classList.remove('theme-dark'); body.classList.add('theme-light'); }
			else { body.classList.remove('theme-light'); body.classList.add('theme-dark'); }
		});
		// Import spreadsheet button
		document.getElementById('importSheetBtn')?.addEventListener('click', async () => {
			const res = await window.electronAPI.showOpenDialog({ properties: ['openFile'], filters: [{ name: 'Spreadsheets', extensions: ['csv','xlsx','xls'] }] });
			if (!res.canceled && res.filePaths?.length) {
				const out = await window.electronAPI.loadLocalSpreadsheet(res.filePaths[0]);
				if (out.success) {
					window.rtxApp.onSheetsConnected(out.data);
					document.getElementById('sheetUrlInput').value = res.filePaths[0];
				} else {
					window.rtxApp.showError('Failed to import: ' + out.error);
				}
			}
		});
		// Logs button
		document.getElementById('logsBtn')?.addEventListener('click', async () => {
			const out = await window.electronAPI.readSessionLog();
			if (out.success) {
				document.getElementById('logsContent').textContent = out.content || '';
				document.getElementById('logsModal').style.display = 'block';
			} else {
				window.rtxApp.showError('Failed to read logs: ' + out.error);
			}
		});
		window.electronAPI.onAppLog?.((d) => {
			const el = document.getElementById('logsContent');
			if (el && document.getElementById('logsModal').style.display === 'block') {
				el.textContent += `\n${new Date(d.ts).toLocaleTimeString()} [${d.level}] ${d.message}`;
			}
		});
		// Data preview UI interactions
		const drawer = document.getElementById('dataPreviewDrawer');
		document.getElementById('togglePreviewBtn')?.addEventListener('click', () => {
			drawer.style.display = drawer.style.display === 'none' ? 'block' : 'none';
		});
		document.getElementById('closePreviewBtn')?.addEventListener('click', () => { drawer.style.display = 'none'; });
		document.getElementById('previewFullscreenBtn')?.addEventListener('click', () => {
			drawer.requestFullscreen?.();
		});
		document.getElementById('previewPosition')?.addEventListener('change', (e) => {
			const pos = e.target.value;
			const container = document.querySelector('.mailer-interface');
			if (!container) return;
			if (pos === 'top') container.insertBefore(drawer, container.children[2]);
			if (pos === 'bottom') container.appendChild(drawer);
			if (pos === 'left') drawer.style.float = 'left';
			if (pos === 'right') drawer.style.float = 'right';
		});
		// Click to insert placeholder
		document.addEventListener('click', (ev) => {
			const target = ev.target;
			if (target?.dataset?.placeholderKey) {
				const key = target.dataset.placeholderKey;
				const ta = document.getElementById('emailContent');
				if (ta) {
					const ins = `((${key}))`;
					const start = ta.selectionStart || ta.value.length;
					ta.value = ta.value.slice(0, start) + ins + ta.value.slice(start);
					window.rtxApp.showSuccess(`Inserted placeholder: ((${key}))`);
				}
			}
		});
		// Search columns
		document.getElementById('placeholderSearch')?.addEventListener('input', (e) => {
			const q = (e.target.value || '').toLowerCase();
			const chips = document.querySelectorAll('[data-placeholder-key]');
			chips.forEach(c => { c.style.display = c.dataset.placeholderKey.toLowerCase().includes(q) ? 'inline-flex' : 'none'; });
		});
		// Assistant search filters below content
		document.getElementById('assistantSearch')?.addEventListener('input', (e) => {
			const q = (e.target.value || '').toLowerCase();
			document.querySelectorAll('#assistantChips [data-placeholder-key]')?.forEach(c => { c.style.display = c.dataset.placeholderKey.toLowerCase().includes(q) ? 'inline-flex' : 'none'; });
		});

		// Help dropdown listeners
		(function(){
			const helpBtn = document.getElementById('helpToolbarBtn');
			const helpMenu = document.getElementById('helpDropdown');
			const closeAll = (ev) => {
				if (!helpMenu) return;
				if (ev && (helpMenu.contains(ev.target) || helpBtn.contains(ev.target))) return;
				helpMenu.style.display = 'none';
			};
			helpBtn?.addEventListener('click', (e) => {
				e.stopPropagation();
				if (!helpMenu) return;
				helpMenu.style.display = helpMenu.style.display === 'none' ? 'block' : 'none';
			});
			document.addEventListener('click', closeAll);
			document.getElementById('helpCheckBtn')?.addEventListener('click', () => { try { window.electronAPI?.checkForUpdates?.(); } catch(_){} closeAll({}); });
			document.getElementById('helpAboutBtn')?.addEventListener('click', () => { try { window.rtxApp?.openAboutModal?.(); } catch(_){} closeAll({}); });
			document.getElementById('helpWelcomeBtn')?.addEventListener('click', () => { try { window.rtxApp?.openWelcomeModal?.(); } catch(_){} closeAll({}); });
			document.getElementById('helpReleaseNotesBtn')?.addEventListener('click', () => { try { window.rtxApp?.openReleaseNotesModal?.(); } catch(_){} closeAll({}); });
		})();

		// Signature Builder actions
		document.getElementById('saveSignatureBtn')?.addEventListener('click', async () => {
			const name = document.getElementById('sigName').value?.trim();
			const html = document.getElementById('sigHtml').value || '';
			if (!name) { window.rtxApp.showError('Please enter signature name'); return; }
			const list = (await window.electronAPI.storeGet('signatures')) || [];
			const filtered = Array.isArray(list) ? list.filter(s => s.name !== name) : [];
			filtered.unshift({ name, html, ts: Date.now() });
			await window.electronAPI.storeSet('signatures', filtered);
			document.getElementById('sigPreview').innerHTML = html;
			window.rtxApp.showSuccess('Signature saved');
		});
		document.getElementById('loadSignatureBtn')?.addEventListener('click', async () => {
			const list = (await window.electronAPI.storeGet('signatures')) || [];
			if (!Array.isArray(list) || !list.length) { window.rtxApp.showError('No saved signatures'); return; }
			const pick = list[0];
			document.getElementById('sigName').value = pick.name || '';
			document.getElementById('sigHtml').value = pick.html || '';
			document.getElementById('sigPreview').innerHTML = pick.html || '';
		});
		document.getElementById('deleteSignatureBtn')?.addEventListener('click', async () => {
			const name = document.getElementById('sigName').value?.trim();
			const list = (await window.electronAPI.storeGet('signatures')) || [];
			const filtered = Array.isArray(list) ? list.filter(s => s.name !== name) : [];
			await window.electronAPI.storeSet('signatures', filtered);
			window.rtxApp.showSuccess('Signature deleted');
		});

		// Update banner wiring
		(function(){
			try {
				const banner = document.getElementById('updateBanner');
				const text = document.getElementById('updateBannerText');
				const action = document.getElementById('updateActionBtn');
				let lastInfo = null;
				if (window.electronAPI?.onUpdateStatus) {
					window.electronAPI.onUpdateStatus((data) => {
						if (!data) return;
						if (data.status === 'available') {
							lastInfo = data.info || null;
							if (text) text.textContent = `New version ${data.info?.version} is available`;
							if (banner) banner.style.display = 'block';
							if (action) {
								action.textContent = 'Download';
								action.onclick = () => window.electronAPI?.downloadUpdate?.();
							}
						} else if (data.status === 'downloading') {
							if (text) text.textContent = `Downloading update... ${Math.round(data.progress?.percent || 0)}%`;
							if (banner) banner.style.display = 'block';
							if (action) { action.textContent = 'Please wait'; action.disabled = true; }
						} else if (data.status === 'downloaded') {
							if (text) text.textContent = 'Update downloaded. Click install to restart.';
							if (banner) banner.style.display = 'block';
							if (action) { action.disabled = false; action.textContent = 'Install'; action.onclick = () => window.electronAPI?.quitAndInstall?.(); }
						} else if (data.status === 'none') {
							if (banner) banner.style.display = 'none';
						} else if (data.status === 'error') {
							if (text) text.textContent = 'Update check failed';
							if (banner) banner.style.display = 'block';
							if (action) { action.textContent = 'Retry'; action.disabled = false; action.onclick = () => window.electronAPI?.checkForUpdates?.(); }
						}
					});
				}
				// On first load, perform a check; older v1.4.0 will show available → static banner
				setTimeout(() => { try { window.electronAPI?.checkForUpdates?.(); } catch (_) {} }, 3000);
			} catch (_) {}
		})();

		// Google Sign-in functions
		async function startGoogleAuth() {
			const oauthFile = document.getElementById('oauthFile').files[0];
			let credentials = null;
			
			if (oauthFile) {
				try {
					const text = await oauthFile.text();
					credentials = JSON.parse(text);
				} catch (error) {
					showError('Invalid OAuth credentials file: ' + error.message);
					return;
				}
			}
			
			showAuthProgress('Starting Google authentication...');
			hideAuthError();
			
			try {
				const result = await window.electronAPI.authenticateGoogle(credentials || {});
				if (result.success) {
					showAuthProgress('Authentication successful! Redirecting...');
					setTimeout(() => {
						document.getElementById('googleSignInModal').style.display = 'none';
						window.location.reload();
					}, 1500);
				} else {
					showAuthError(result.error || 'Authentication failed');
				}
			} catch (error) {
				showAuthError('Authentication error: ' + error.message);
			}
		}
		
		async function submitManualAuthCode() {
			const code = document.getElementById('manualAuthCode').value.trim();
			if (!code) {
				showError('Please enter an authorization code');
				return;
			}
			
			showAuthProgress('Processing authorization code...');
			hideAuthError();
			
			try {
				const result = await window.electronAPI.submitManualAuthCode(code);
				if (result.success) {
					showAuthProgress('Authorization successful! Redirecting...');
					setTimeout(() => {
						document.getElementById('googleSignInModal').style.display = 'none';
						window.location.reload();
					}, 1500);
				} else {
					showAuthError(result.error || 'Authorization failed');
				}
			} catch (error) {
				showAuthError('Authorization error: ' + error.message);
			}
		}
		
		function showAuthProgress(message) {
			document.getElementById('authProgress').style.display = 'block';
			document.getElementById('authStatus').textContent = message;
			document.getElementById('startAuthBtn').disabled = true;
		}
		
		function hideAuthProgress() {
			document.getElementById('authProgress').style.display = 'none';
			document.getElementById('startAuthBtn').disabled = false;
		}
		
		function showAuthError(message) {
			document.getElementById('authError').style.display = 'block';
			document.getElementById('errorMessage').textContent = message;
			hideAuthProgress();
		}
		
		function hideAuthError() {
			document.getElementById('authError').style.display = 'none';
		}
		
		// Handle OAuth file selection
		document.getElementById('oauthFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				console.log('OAuth file selected:', file.name);
			}
		});
		
		// Handle Enter key in manual auth code input
		document.getElementById('manualAuthCode').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				submitManualAuthCode();
			}
		});
		
		// Debug functions for troubleshooting authentication
		async function debugAuthStatus() {
			try {
				const result = await window.electronAPI.debugAuthStatus();
				if (result.success) {
					const debugOutput = document.getElementById('debugOutput');
					debugOutput.style.display = 'block';
					debugOutput.innerHTML = '<strong>Debug Information:</strong><br>' + 
						JSON.stringify(result.status, null, 2);
				} else {
					showError('Failed to get debug info: ' + result.error);
				}
			} catch (error) {
				showError('Debug error: ' + error.message);
			}
		}
		
		async function clearAuthData() {
			if (confirm('This will clear all authentication data and force you to sign in again. Continue?')) {
				try {
					// Clear local storage
					localStorage.clear();
					
					// Clear form fields
					document.getElementById('manualAuthCode').value = '';
					document.getElementById('oauthFile').value = '';
					
					// Hide any error/progress displays
					hideAuthError();
					hideAuthProgress();
					
					// Show success message
					showSuccess('Authentication data cleared. Please sign in again.');
					
					// Hide debug output
					document.getElementById('debugOutput').style.display = 'none';
				} catch (error) {
					showError('Failed to clear auth data: ' + error.message);
				}
			}
		}
		
		function showAuthHelp() {
			const helpText = `
<strong>Authentication Help:</strong><br><br>
<strong>Manual Authorization Code (Recommended):</strong><br>
1. Click "Start Google Sign-in" to open Google in your browser<br>
2. Complete the Google authorization process<br>
3. Copy the authorization code from the success page<br>
4. Paste it here and click "Login"<br><br>
<strong>If you get "Invalid or expired code":</strong><br>
• Authorization codes can only be used once<br>
• Codes expire quickly (usually within 10 minutes)<br>
• Get a fresh code by clicking "Start Google Sign-in" again<br><br>
<strong>Common Issues:</strong><br>
• Make sure you're using the latest version of the app<br>
• Check that your internet connection is working<br>
• Try clearing auth data if problems persist<br>
• Ensure you have the required Google APIs enabled
			`;
			
			alert(helpText);
		}

		// Signature builder functions
	</script>

	<!-- Enhanced Editor Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

	<style>
		/* Force page scroll */
		html, body { height: auto; overflow-y: auto; }
		.app-container { min-height: 100vh; }

		/* Theme-aware notifications */
		body.theme-dark { background:#0b0b0f; color:#e6e6e9; }
		body.theme-dark .mailer-interface { background:#14141a; }
		.notification { background:#1f1f27; color:#f0f0f5; border:1px solid #2a2a37; }
		.notification-success { background:#1d3b24; }
		.notification-error { background:#4a1f1f; }
		body.theme-dark .modal-content { background:#14141a; color:#e6e6e9; }

		/* Dark theme for form controls */
		body.theme-dark .form-group input,
		body.theme-dark .form-group textarea,
		body.theme-dark .form-group select { background:#1b1b22; color:#e6e6e9; border-color:#2a2a37; }
		body.theme-dark .btn-secondary { background:#262633; color:#e6e6e9; border:1px solid #2a2a37; }
		body.theme-dark .btn-primary { background:#0a69ff; color:#fff; }

		/* Override inline light backgrounds in dark mode */
		body.theme-dark [style*='background: #f2f2f7'] { background:#1b1b22 !important; border-color:#2a2a37 !important; }
		body.theme-dark [style*='background: #ffffff'] { background:#14141a !important; }

		/* Tables and badges */
		body.theme-dark table { color:#e6e6e9; }
		body.theme-dark th { background:#1f1f27; }
		body.theme-dark td, body.theme-dark th { border-bottom:1px solid #2a2a37; }
		body.theme-dark .status-indicator.connected { background:#1f8b4c; }
		body.theme-dark .status-indicator.disconnected { background:#7a2d2d; }
		body.theme-dark small { color:#9a9ab3; }
		body.theme-dark .chip { background:#1f1f27 !important; border:1px solid #2a2a37 !important; color:#e6e6e9; }

		/* Responsive */
		@media (max-width: 900px) {
			.header { flex-wrap: wrap; gap:8px; }
			.mailer-interface { padding:16px; }
			[data-placeholder-key] { font-size:12px; cursor: pointer; }
		}
		@media (max-width: 600px) {
			.header button { padding:8px 12px; }
			.form-group input, .form-group select, .form-group textarea { font-size:13px; }
		}
		/* Spinner for loading states */
		.spinner {
			border: 2px solid #f3f3f3;
			border-top: 2px solid #3498db;
			border-radius: 50%;
			width: 20px;
			height: 20px;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		
		/* Modal improvements */
		.modal-content {
			max-height: 90vh;
			overflow-y: auto;
		}
		
		.form-group {
			margin-bottom: 16px;
		}
		
		.form-group label {
			display: block;
			margin-bottom: 6px;
			font-weight: 500;
			color: #333;
		}
		
		.form-group input,
		.form-group select {
			width: 100%;
			padding: 8px 12px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}
		
		.form-group small {
			display: block;
			margin-top: 4px;
			color: #666;
			font-size: 12px;
		}
		
		/* Button improvements */
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s ease;
		}
		
		.btn:disabled {
			opacity: 0.6;
			cursor: not-allowed;
		}
		
		.btn-primary {
			background: #007aff;
			color: white;
		}
		
		.btn-primary:hover:not(:disabled) {
			background: #0056cc;
		}
		
		.btn-secondary {
			background: #f0f0f0;
			color: #333;
			border: 1px solid #ddd;
		}
		
		.btn-secondary:hover:not(:disabled) {
			background: #e0e0e0;
		}
	</style>
</body>
</html> 